# Deploy - 30/11/2025

## Informações Gerais
- **Data**: 30/11/2025 15:41 (horário de Brasília)
- **Servidor**: 72.60.158.156 (root)
- **Branch**: life-system → origin/life-system
- **Commits**: 8e836cd (1 commit deployado)
- **Arquivos modificados**: 4 arquivos (+270 linhas, -53 linhas)

## Resumo das Mudanças
- Implementada distribuição proporcional de receitas entre atendentes no ranking
- Criação automática de registros em `contract_agents` ao efetivar contratos
- Anexos agora persistem entre todos os casos do mesmo cliente
- Correções de bugs em SQL e cálculo de consultoria líquida
- Números de contratos sempre exibidos como inteiros

## Detalhes das Mudanças

### 1. Módulo Finance (`apps/api/app/routers/finance.py`)
**Funcionalidade**: Distribuição automática de contratos entre atendentes

- ✅ Criação automática de registros em `ContractAgent` ao efetivar contratos via `/finance/disburse-simple`
- ✅ Suporte para até 2 atendentes + balcão na distribuição de receita
- ✅ Registro do percentual de cada atendente no contrato (0-100%)
- ✅ Flag `is_primary` para identificar atendente principal

**Exemplo de uso**:
```json
{
  "atendente1_user_id": 14,
  "percentual_atendente1": 30,
  "atendente2_user_id": 11,
  "percentual_atendente2": 30
}
```

**Resultado**: Cria 3 registros em `contract_agents`:
- Daniel: 30% (is_primary=true)
- Carol: 30% (is_primary=false)
- Balcão: 40% (is_primary=false)

### 2. Módulo Rankings (`apps/api/app/routers/rankings.py`)
**Funcionalidade**: Contagem proporcional de contratos e correções

#### Mudanças principais:
1. **Contagem proporcional de contratos**:
   - Contratos compartilhados são contados proporcionalmente ao percentual do atendente
   - Exemplo: Atendente com 30% de um contrato = 0.3 contratos
   - Contratos legados (sem `ContractAgent`) = 1 contrato completo

2. **Arredondamento para inteiro**:
   - Todos os números de contratos são arredondados para cima (`math.ceil`)
   - 0.3 contratos → 1 contrato
   - Melhora visualização para usuários finais

3. **Novos tipos de receita suportados**:
   ```python
   "Consultoria Líquida - Atendente",
   "Consultoria Líquida - Atendente 1",  # NOVO
   "Consultoria Líquida - Atendente 2",  # NOVO
   "Consultoria Líquida - Balcão",
   "Consultoria Líquida",
   "Contrato Mobile"  # NOVO
   ```

4. **Correção de SQL syntax error**:
   - Substituído `func.or_()` e `func.and_()` por `or_()` e `and_()` corretos
   - Import adicionado: `from sqlalchemy import or_, and_`
   - Adicionado: `import math`

#### Endpoints afetados:
- `GET /rankings/agents` - Ranking geral com contagem proporcional
- `GET /rankings/agents/{user_id}/contracts` - Contratos de um usuário específico

**Campos novos no response**:
```json
{
  "consultoria_proporcional": 157.14,
  "percentual_usuario": 29.44
}
```

### 3. Módulo Cases (`apps/api/app/routers/cases.py`)
**Funcionalidade**: Anexos persistem entre casos do mesmo cliente

#### Mudança no endpoint `GET /cases/{case_id}/attachments`:
- **Antes**: Retornava apenas anexos do caso atual
- **Agora**: Retorna anexos de TODOS os casos do mesmo cliente

**Campos novos**:
```json
{
  "case_id": 123,
  "is_from_current_case": true
}
```

**Benefício**: Ao criar novo caso para cliente com histórico, anexos anteriores ficam disponíveis automaticamente.

### 4. Frontend (`apps/web/src/components/rankings/ContractsDetailsModal.tsx`)
**Funcionalidade**: Limpeza de interface

- ❌ Removido período incorreto do cabeçalho do modal
- Antes: "Período: 31/10/2025 - 29/11/2025" (incorreto)
- Agora: Apenas título "Contratos de {userName}"

## Scripts de Correção Criados

Durante o desenvolvimento foram criados scripts auxiliares (não commitados):

1. **fix_contract_distribution.py**: Corrige distribuição de um contrato específico por CPF
2. **fix_all_contracts_distribution.py**: Tentativa de corrigir todos os contratos (falhou devido a dados legados incorretos)
3. **test_consultoria_daniel_carol.py**: Teste de receitas de Daniel e Carol

## Processo de Deploy Recomendado

### 1. Backup do Banco de Dados
```bash
# Criar backup comprimido
docker exec src-db-1 pg_dump -U lifecalling -d lifecalling -F custom -f /tmp/backup-20251130-deploy.backup

# Criar backup plain text (completo)
docker exec src-db-1 bash -c "pg_dump -U lifecalling -d lifecalling -F plain > /tmp/backup-plain-20251130.sql"

# Copiar para host
docker cp src-db-1:/tmp/backup-plain-20251130.sql /opt/lifeservicos/backups/deploy-backup-plain-20251130.sql

# Limpar backups antigos (manter últimos 7 dias)
cd /opt/lifeservicos/backups
find . -maxdepth 1 -type f -mtime +7 -name "*.sql" -o -name "*.backup" | xargs rm -f
```

### 2. Atualização do Código no Servidor
```bash
# SSH no servidor
ssh root@72.60.158.156

# Navegar para diretório
cd /opt/lifeservicos/src

# Pull das mudanças
git fetch origin
git checkout life-system
git pull origin life-system

# Verificar commit
git log -1 --oneline
# Esperado: 8e836cd feat: Implementar distribuição proporcional de receitas no ranking
```

### 3. Rebuild e Restart dos Containers
```bash
cd /opt/lifeservicos/src

# Parar containers API e Web
docker compose -f docker-compose.prod.yml stop api web

# Rebuild (se necessário - mudanças em Python não requerem rebuild)
docker compose -f docker-compose.prod.yml build api web

# Reiniciar containers
docker compose -f docker-compose.prod.yml up -d api web

# Verificar logs
docker compose -f docker-compose.prod.yml logs -f --tail=50 api
```

### 4. Verificação Final
```bash
# Verificar status dos containers
docker compose -f docker-compose.prod.yml ps

# Testar API
curl -s https://api.lifeservicos.com/health
# Esperado: {"status":"ok","message":"Lifecalling API está funcionando"}

# Verificar tabela contract_agents existe
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "\d contract_agents"

# Verificar se há dados em contract_agents
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "SELECT COUNT(*) FROM contract_agents;"
```

### 5. Teste Funcional

1. **Efetivar um novo contrato** com distribuição (ex: Daniel 30%, Carol 30%)
2. **Verificar no módulo Rankings**:
   - Daniel deve ter 1 contrato
   - Carol deve ter 1 contrato
   - Consultoria Total deve mostrar R$ 157,14 (ou valor proporcional)
3. **Criar novo caso** para cliente com casos anteriores:
   - Anexos dos casos anteriores devem aparecer automaticamente

## Correção de Contrato Existente

Para corrigir manualmente um contrato que foi efetivado antes deste deploy:

```bash
# SSH no servidor
ssh root@72.60.158.156

# Entrar no container da API
docker exec -it src-api-1 bash

# Rodar script de correção (criar arquivo temporário)
cat > /tmp/fix_contract.py << 'EOF'
from app.db import SessionLocal
from app.models import Contract, Case, Client, ContractAgent, FinanceIncome
from sqlalchemy import and_

def fix_contract(cpf: str):
    cpf_normalized = cpf.replace(".", "").replace("-", "")
    db = SessionLocal()

    try:
        client = db.query(Client).filter(Client.cpf == cpf_normalized).first()
        if not client:
            print(f"❌ Cliente com CPF {cpf} não encontrado")
            return

        case = db.query(Case).filter(Case.client_id == client.id).first()
        if not case:
            print(f"❌ Nenhum caso encontrado")
            return

        contract = db.query(Contract).filter(Contract.case_id == case.id).first()
        if not contract:
            print(f"❌ Nenhum contrato encontrado")
            return

        # Buscar receitas
        incomes = db.query(FinanceIncome).filter(
            FinanceIncome.income_name.like(f"%Contrato #{contract.id}%")
        ).all()

        if not incomes:
            print(f"❌ Nenhuma receita encontrada")
            return

        consultoria_total = float(contract.consultoria_valor_liquido or 0)

        for income in incomes:
            valor = float(income.amount)
            percentual = (valor / consultoria_total * 100) if consultoria_total > 0 else 0

            agent = ContractAgent(
                contract_id=contract.id,
                user_id=income.agent_user_id,
                percentual=round(percentual, 2),
                is_primary=income.income_type in ["Consultoria Líquida - Atendente 1"]
            )
            db.add(agent)

        db.commit()
        print(f"✅ Contrato #{contract.id} corrigido com sucesso!")

    except Exception as e:
        db.rollback()
        print(f"❌ Erro: {str(e)}")
    finally:
        db.close()

# Exemplo de uso
fix_contract("600.879.343-96")
EOF

python /tmp/fix_contract.py
```

## Migrations

**Nenhuma migration necessária** - As mudanças usam a tabela `contract_agents` existente (criada em deploy anterior).

## Impacto nos Usuários

### Positivo ✅
- Ranking agora reflete corretamente a distribuição de contratos entre atendentes
- Números de contratos mais legíveis (inteiros ao invés de decimais)
- Anexos de casos anteriores ficam disponíveis automaticamente
- Consultoria total mostra valores corretos (não mais zerado)

### Neutro ⚠️
- Contratos antigos (antes deste deploy) ainda usam lógica legada (1 contrato = 100%)
- Para corrigir contratos antigos, usar script de correção manual

### Negativo ❌
- Nenhum impacto negativo identificado

## Testes Realizados

### Backend
- ✅ Criação de `ContractAgent` ao efetivar contrato
- ✅ Contagem proporcional de contratos no ranking
- ✅ Cálculo correto de consultoria líquida
- ✅ Anexos de todos os casos do cliente
- ✅ Arredondamento de contratos para inteiro

### Frontend
- ✅ Modal de contratos sem período incorreto
- ✅ Exibição de contratos como números inteiros
- ✅ Consultoria total mostrando valores corretos

### Dados de Teste
**Contrato #70** - TERESA CRISTINA VELOSO DE (CPF 600.879.343-96):
- Consultoria Líquida Total: R$ 533,79
- Daniel (ID 14): R$ 157,14 (29.44%)
- Carol (ID 11): R$ 157,14 (29.44%)
- Balcão: R$ 209,52 (39.25%)

## Comandos de Rollback (se necessário)

### Restaurar Backup
```bash
# Parar API e Web
docker compose -f docker-compose.prod.yml stop api web

# Restaurar backup
docker cp /opt/lifeservicos/backups/deploy-backup-plain-20251130.sql src-db-1:/tmp/
docker exec src-db-1 psql -U lifecalling -d lifecalling -f /tmp/deploy-backup-plain-20251130.sql

# Reiniciar containers
docker compose -f docker-compose.prod.yml up -d api web
```

### Reverter Código
```bash
cd /opt/lifeservicos/src
git reset --hard ec5bf84  # commit anterior
docker compose -f docker-compose.prod.yml restart api web
```

## Arquivos Modificados

1. **apps/api/app/routers/finance.py** (+85 linhas)
   - Criação de `ContractAgent` no endpoint `/finance/disburse-simple`

2. **apps/api/app/routers/rankings.py** (+122 linhas)
   - Contagem proporcional de contratos
   - Suporte para novos tipos de receita
   - Correção de operadores SQL
   - Arredondamento para inteiro

3. **apps/api/app/routers/cases.py** (+43 linhas)
   - Anexos de todos os casos do cliente
   - Novos campos: `case_id`, `is_from_current_case`

4. **apps/web/src/components/rankings/ContractsDetailsModal.tsx** (-3 linhas)
   - Remoção de período incorreto

**Total**: 4 arquivos, +270 linhas, -53 linhas

## Monitoramento Pós-Deploy

### Métricas a Observar
1. **Logs de erro** nos containers API e Web
2. **Tempo de resposta** do endpoint `/rankings/agents`
3. **Uso de CPU/Memória** dos containers
4. **Queries lentas** no PostgreSQL (table scans em `contract_agents`)

### Alertas
Se houver problemas de performance:
```sql
-- Verificar uso de índices
EXPLAIN ANALYZE SELECT * FROM contract_agents WHERE contract_id = 70;

-- Criar índice se necessário (já existe)
CREATE INDEX IF NOT EXISTS ix_contract_agent_unique ON contract_agents(contract_id, user_id);
```

## Próximos Passos

1. **Monitorar** performance do módulo de rankings nas primeiras 24h
2. **Educar usuários** sobre nova funcionalidade de distribuição proporcional
3. **Corrigir contratos antigos** se necessário (usar script manual)
4. **Considerar** adicionar indicador visual no frontend para contratos compartilhados

## Notas Técnicas

### SQL Operators Fix
Erro original:
```python
func.or_()  # ❌ INCORRETO
func.and_() # ❌ INCORRETO
```

Correção:
```python
from sqlalchemy import or_, and_
or_(...)   # ✅ CORRETO
and_(...)  # ✅ CORRETO
```

### Math Import
Adicionado no topo de `rankings.py`:
```python
import math
```

Usado para arredondamento:
```python
contracts_map[user_id]["qtd"] = math.ceil(contracts_map[user_id]["qtd"])
```

## Contatos de Emergência
- **Servidor**: root@72.60.158.156
- **Caminho**: /opt/lifeservicos/src
- **GitHub**: https://github.com/ghitflux/lifeservicos
- **Backup**: /opt/lifeservicos/backups/
- **Branch**: life-system

## Observações Finais

1. **Tabela `contract_agents`**: Criada em deploy anterior, apenas sendo populada agora
2. **Contratos legados**: Mantêm comportamento antigo (1 contrato = 100%)
3. **Performance**: Queries adicionais para buscar `ContractAgent`, mas com índice otimizado
4. **Compatibilidade**: Totalmente retrocompatível com contratos existentes

---
**Documentado por**: Claude Code
**Commit**: 8e836cd
**Branch**: life-system
**Data**: 30/11/2025 15:41 (BRT)
