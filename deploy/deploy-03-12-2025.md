# Deploy - 03/12/2025

## ‚ö†Ô∏è ALERTA CR√çTICO - BACKUP
**Na √∫ltima atualiza√ß√£o houve um problema cr√≠tico**: o backup foi criado mas veio com banco de dados vazio!

**PROCEDIMENTO OBRIGAT√ìRIO**:
1. ‚úÖ Criar backup
2. ‚úÖ **VALIDAR** que o backup cont√©m dados
3. ‚úÖ **TESTAR** restaura√ß√£o em ambiente de teste
4. ‚úÖ S√≥ ent√£o prosseguir com o deploy

## Informa√ß√µes Gerais
- **Data**: 03/12/2025
- **Servidor**: 72.60.158.156 (root)
- **Diret√≥rio**: /opt/lifeservicos/src (N√ÉO MUDAR)
- **Branch**: life-system ‚Üí origin/life-system
- **Commit**: 0d7484f
- **Arquivos modificados**: 6 arquivos (+352 linhas, -87 linhas)

## Resumo das Mudan√ßas

### 1. Otimiza√ß√£o de Mensalidades ‚ö°
- Sistema agora mant√©m **apenas 1 mensalidade** (a mais recente) por contrato
- Antes: mantinha 2 mensalidades
- **Limpeza executada**: 88,625 linhas removidas (~44 MB)
- Criado script autom√°tico de limpeza: `cleanup_old_payroll_data.py`

### 2. Corre√ß√£o de Filtros no M√≥dulo de Atendimento üîç
- **Filtro por Banco**: Corrigido para aceitar nomes normalizados
- **Filtro por Cargo**: Implementado do zero (n√£o existia)
- **Filtros Cruzados**: Banco + Cargo + Status funcionam simultaneamente
- Problema resolvido: dropdowns n√£o filtravam os cards

### 3. Melhorias de UX - Navega√ß√£o entre Casos üöÄ
- **Removido modal obrigat√≥rio** de justificativa ao navegar
- Navega√ß√£o instant√¢nea entre casos (Pr√≥ximo/Anterior)
- Usu√°rio pode pular casos sem comentar

## Arquivos Modificados

1. **apps/api/app/routers/cases.py** (+58 linhas)
   - Adicionado filtro por `cargo` (par√¢metro novo)
   - Filtro por `entidade` aceita nomes normalizados
   - Busca autom√°tica de varia√ß√µes de nomes de banco (ex: "BANCO DO BRASIL S.A" ‚Üí "BANCO DO BRASIL")

2. **apps/api/app/routers/imports.py** (+10 linhas, -10 linhas)
   - Fun√ß√£o `cleanup_old_references()`: muda de `rn > 2` para `rn > 1`
   - Limpeza autom√°tica ap√≥s cada importa√ß√£o de folha

3. **apps/api/cleanup_payroll_references.py** (+10 linhas, -10 linhas)
   - Atualizado para manter apenas 1 mensalidade
   - Documenta√ß√£o atualizada

4. **apps/api/cleanup_old_payroll_data.py** (NOVO - 352 linhas)
   - Script de limpeza √∫nica com valida√ß√£o
   - Modo `--dry-run` para simula√ß√£o
   - Estat√≠sticas detalhadas antes/depois
   - Confirma√ß√£o obrigat√≥ria: usu√°rio deve digitar "CONFIRMO"

5. **apps/web/src/lib/query.ts** (+5 linhas)
   - Tipo `Filters`: adicionado `banco` e `cargo`
   - Fun√ß√£o `buildCasesQuery`: processa filtros de banco e cargo
   - `banco` √© alias para `entidade` (compatibilidade)

6. **apps/web/src/app/casos/[id]/page.tsx** (-30 linhas)
   - Removido modal de navega√ß√£o completo
   - Fun√ß√£o `handleNavigate` simplificada (n√£o async)
   - Estados removidos: `navigationReason`, `showNavigationDialog`, `navigationDirection`

## Migrations

**Nenhuma migration necess√°ria** - As mudan√ßas usam tabelas e campos existentes.

## Impacto nos Usu√°rios

### Positivo ‚úÖ
- Filtros de atendimento funcionam corretamente (banco, cargo, status)
- Navega√ß√£o entre casos mais r√°pida e fluida
- Banco de dados mais leve (~44 MB economizados)
- Sistema mais r√°pido (menos dados para processar)

### Neutro ‚ö†Ô∏è
- Mensalidades antigas foram removidas (apenas a mais recente √© mantida)
- Para consultar hist√≥rico, usar relat√≥rios antes do deploy

### Negativo ‚ùå
- Nenhum impacto negativo identificado

---

## PROCEDIMENTO DE DEPLOY

### ‚ö†Ô∏è ETAPA 0: VALIDA√á√ÉO PR√â-DEPLOY (OBRIGAT√ìRIA)

```bash
# SSH no servidor
ssh root@72.60.158.156

# Verificar diret√≥rio correto
cd /opt/lifeservicos/src
pwd
# Esperado: /opt/lifeservicos/src

# Verificar branch atual
git branch
# Esperado: * life-system

# Verificar √∫ltimo commit
git log -1 --oneline
# Esperado: c2d4a71 ou mais recente

# Verificar status dos containers
docker compose -f docker-compose.prod.yml ps
# Todos devem estar "Up"
```

---

### ETAPA 1: BACKUP DO BANCO DE DADOS ‚ö†Ô∏è CR√çTICO

#### 1.1. Criar Backup Completo

```bash
# Criar diret√≥rio de backups com data
BACKUP_DIR="/opt/lifeservicos/backups/deploy-$(date +%Y%m%d-%H%M%S)"
mkdir -p $BACKUP_DIR

# Backup formato CUSTOM (comprimido, restaur√°vel)
docker exec src-db-1 pg_dump \
  -U lifecalling \
  -d lifecalling \
  -F custom \
  -f /tmp/backup-custom.backup

# Backup formato PLAIN TEXT (leg√≠vel, audit√°vel)
docker exec src-db-1 pg_dump \
  -U lifecalling \
  -d lifecalling \
  -F plain \
  > /tmp/backup-plain.sql

# Copiar backups para host
docker cp src-db-1:/tmp/backup-custom.backup $BACKUP_DIR/
docker cp src-db-1:/tmp/backup-plain.sql $BACKUP_DIR/

echo "Backups criados em: $BACKUP_DIR"
```

#### 1.2. ‚ö†Ô∏è VALIDAR BACKUP (OBRIGAT√ìRIO)

```bash
# Verificar tamanho dos arquivos (devem ser > 100 KB)
ls -lh $BACKUP_DIR/
# backup-custom.backup deve ter ~10-50 MB
# backup-plain.sql deve ter ~20-100 MB

# Contar linhas do backup plain (deve ter milhares)
wc -l $BACKUP_DIR/backup-plain.sql
# Esperado: > 10000 linhas

# Verificar se backup cont√©m dados de tabelas cr√≠ticas
grep -c "INSERT INTO" $BACKUP_DIR/backup-plain.sql
# Esperado: > 100

grep -c "clients" $BACKUP_DIR/backup-plain.sql
# Esperado: > 50

grep -c "cases" $BACKUP_DIR/backup-plain.sql
# Esperado: > 50

grep -c "payroll_lines" $BACKUP_DIR/backup-plain.sql
# Esperado: > 100

# Verificar se N√ÉO est√° vazio
if [ $(wc -l < $BACKUP_DIR/backup-plain.sql) -lt 1000 ]; then
  echo "‚ùå ERRO: Backup parece estar vazio ou corrompido!"
  echo "‚ùå N√ÉO PROSSIGA COM O DEPLOY!"
  exit 1
else
  echo "‚úÖ Backup validado com sucesso"
fi
```

#### 1.3. üß™ TESTAR RESTAURA√á√ÉO (ALTAMENTE RECOMENDADO)

```bash
# Criar banco de teste
docker exec src-db-1 psql -U lifecalling -c "CREATE DATABASE lifecalling_test;"

# Restaurar backup no banco de teste
docker cp $BACKUP_DIR/backup-custom.backup src-db-1:/tmp/
docker exec src-db-1 pg_restore \
  -U lifecalling \
  -d lifecalling_test \
  -c \
  /tmp/backup-custom.backup

# Verificar se dados foram restaurados
docker exec src-db-1 psql -U lifecalling -d lifecalling_test -c "
  SELECT 'clients' as table, COUNT(*) as count FROM clients
  UNION ALL
  SELECT 'cases', COUNT(*) FROM cases
  UNION ALL
  SELECT 'payroll_lines', COUNT(*) FROM payroll_lines
  UNION ALL
  SELECT 'contracts', COUNT(*) FROM contracts;
"
# Todas as contagens devem ser > 0

# Se teste OK, remover banco de teste
docker exec src-db-1 psql -U lifecalling -c "DROP DATABASE lifecalling_test;"

echo "‚úÖ Teste de restaura√ß√£o bem-sucedido!"
```

#### 1.4. Limpar Backups Antigos (> 30 dias)

```bash
# Manter backups dos √∫ltimos 30 dias
find /opt/lifeservicos/backups -maxdepth 1 -type d -mtime +30 -exec rm -rf {} \;
```

---

### ETAPA 2: ATUALIZAR C√ìDIGO NO SERVIDOR

```bash
# Navegar para diret√≥rio
cd /opt/lifeservicos/src

# Fazer stash de mudan√ßas locais (se houver)
git stash

# Fetch das mudan√ßas
git fetch origin

# Verificar diferen√ßas antes de fazer pull
git log --oneline HEAD..origin/life-system

# Pull das mudan√ßas
git pull origin life-system

# Verificar commit atual
git log -1 --oneline
# Esperado: 0d7484f feat: Melhorias no sistema de atendimento e mensalidades

# Verificar arquivos modificados
git show --name-only 0d7484f
```

---

### ETAPA 3: PARAR CONTAINERS API E WEB

```bash
cd /opt/lifeservicos/src

# Parar apenas API e Web (mant√©m DB rodando)
docker compose -f docker-compose.prod.yml stop api web

# Verificar status
docker compose -f docker-compose.prod.yml ps
# api e web devem estar "Exited"
# db deve estar "Up"
```

---

### ETAPA 4: REBUILD DOS CONTAINERS (SE NECESS√ÅRIO)

```bash
# Para mudan√ßas apenas em Python (.py) e TypeScript (.tsx, .ts):
# N√ÉO √© necess√°rio rebuild, basta restart

# Verificar se h√° mudan√ßas em Dockerfile ou requirements.txt
git diff HEAD~1 --name-only | grep -E 'Dockerfile|requirements.txt|package.json'

# Se houver mudan√ßas, fazer rebuild:
docker compose -f docker-compose.prod.yml build api web

# Caso contr√°rio, pular para ETAPA 5
```

---

### ETAPA 5: REINICIAR CONTAINERS

```bash
cd /opt/lifeservicos/src

# Reiniciar API e Web
docker compose -f docker-compose.prod.yml up -d api web

# Aguardar inicializa√ß√£o (20-30 segundos)
sleep 30

# Verificar status
docker compose -f docker-compose.prod.yml ps
# Todos devem estar "Up" e "healthy"

# Verificar logs iniciais
docker compose -f docker-compose.prod.yml logs --tail=50 api | grep -i error
# N√£o deve haver erros cr√≠ticos
```

---

### ETAPA 6: VERIFICA√á√ÉO FUNCIONAL

#### 6.1. Verificar API

```bash
# Health check
curl -s https://api.lifeservicos.com/health
# Esperado: {"status":"ok","message":"Lifecalling API est√° funcionando"}

# Verificar se filtros est√£o dispon√≠veis
curl -s https://api.lifeservicos.com/clients/filters | jq '.bancos | length'
# Esperado: > 0

curl -s https://api.lifeservicos.com/clients/filters | jq '.cargos | length'
# Esperado: > 0
```

#### 6.2. Verificar Banco de Dados

```bash
# Verificar tabela payroll_lines (ap√≥s limpeza)
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "
  SELECT
    ref_year,
    ref_month,
    COUNT(*) as total
  FROM payroll_lines
  GROUP BY ref_year, ref_month
  ORDER BY ref_year DESC, ref_month DESC
  LIMIT 5;
"
# Deve mostrar distribui√ß√£o de mensalidades (mais recente com mais linhas)

# Verificar se h√° duplicatas (n√£o deve ter)
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "
  SELECT
    cpf,
    matricula,
    financiamento_code,
    COUNT(*) as duplicates
  FROM payroll_lines
  GROUP BY cpf, matricula, financiamento_code
  HAVING COUNT(*) > 1
  LIMIT 10;
"
# Esperado: 0 resultados (sem duplicatas)

# Verificar total de linhas
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "
  SELECT COUNT(*) FROM payroll_lines;
"
# Esperado: ~109,265 linhas (ap√≥s limpeza)
```

#### 6.3. Verificar Frontend

```bash
# Acessar site
curl -s https://lifeservicos.com | grep -q "Life Digital"
echo $?
# Esperado: 0 (site carregou)

# Verificar build
ls -lh /opt/lifeservicos/src/apps/web/.next/
# Deve ter arquivos recentes
```

---

### ETAPA 7: TESTE FUNCIONAL MANUAL

#### 7.1. Testar Filtros de Atendimento

1. Acessar: https://lifeservicos.com/esteira
2. Selecionar filtro **BANCO** (ex: "BANCO DO BRASIL")
3. Verificar que cards filtrados aparecem corretamente
4. Selecionar filtro **CARGO** (ex: "007-DIRETOR")
5. Verificar que filtros cruzados funcionam
6. Clicar em **Limpar filtros**
7. Verificar que todos os casos voltam a aparecer

‚úÖ **Sucesso**: Filtros funcionam corretamente

#### 7.2. Testar Navega√ß√£o entre Casos

1. Acessar um caso: https://lifeservicos.com/casos/46724
2. Clicar no bot√£o **Pr√≥ximo**
3. Verificar que navega diretamente (sem modal)
4. Clicar no bot√£o **Anterior**
5. Verificar que volta ao caso anterior

‚úÖ **Sucesso**: Navega√ß√£o instant√¢nea sem modal

#### 7.3. Testar Importa√ß√£o de Folha (Limpeza Autom√°tica)

1. Acessar: https://lifeservicos.com/importacao
2. Importar arquivo de folha de pagamento
3. Aguardar conclus√£o
4. Verificar logs: `docker logs src-api-1 --tail=100 | grep "Limpeza"`
5. Deve aparecer: "Limpeza conclu√≠da: X linhas antigas removidas"

‚úÖ **Sucesso**: Limpeza autom√°tica funcionando

---

## MONITORAMENTO P√ìS-DEPLOY

### M√©tricas a Observar (primeiras 24h)

```bash
# 1. Logs de erro
docker logs src-api-1 --tail=500 | grep -i error

# 2. Uso de CPU/Mem√≥ria
docker stats --no-stream src-api-1 src-web-1 src-db-1

# 3. Espa√ßo em disco (banco menor)
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "
  SELECT pg_size_pretty(pg_database_size('lifecalling'));
"

# 4. Tempo de resposta da API
time curl -s https://api.lifeservicos.com/health

# 5. Queries lentas no PostgreSQL
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "
  SELECT
    query,
    calls,
    total_exec_time,
    mean_exec_time
  FROM pg_stat_statements
  ORDER BY mean_exec_time DESC
  LIMIT 10;
"
```

### Alertas

Se houver:
- ‚ùå Erros 500 na API ‚Üí Verificar logs
- ‚ùå Timeout em queries ‚Üí Verificar √≠ndices
- ‚ùå Uso alto de mem√≥ria ‚Üí Verificar leaks
- ‚ùå Duplicatas em payroll_lines ‚Üí Executar limpeza manual

---

## ROLLBACK (SE NECESS√ÅRIO)

### Cen√°rio 1: Problema com C√≥digo

```bash
# Reverter c√≥digo
cd /opt/lifeservicos/src
git reset --hard c2d4a71  # commit anterior

# Reiniciar containers
docker compose -f docker-compose.prod.yml restart api web

# Verificar
curl -s https://api.lifeservicos.com/health
```

### Cen√°rio 2: Problema com Banco de Dados

```bash
# PARAR TODOS OS CONTAINERS
docker compose -f docker-compose.prod.yml stop

# Restaurar backup
BACKUP_DIR="/opt/lifeservicos/backups/deploy-YYYYMMDD-HHMMSS"  # Usar o mais recente

# Limpar banco atual
docker exec src-db-1 psql -U lifecalling -c "DROP DATABASE lifecalling;"
docker exec src-db-1 psql -U lifecalling -c "CREATE DATABASE lifecalling;"

# Restaurar backup custom
docker cp $BACKUP_DIR/backup-custom.backup src-db-1:/tmp/
docker exec src-db-1 pg_restore \
  -U lifecalling \
  -d lifecalling \
  -c \
  /tmp/backup-custom.backup

# Verificar restaura√ß√£o
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "
  SELECT COUNT(*) FROM clients;
  SELECT COUNT(*) FROM cases;
  SELECT COUNT(*) FROM payroll_lines;
"

# Reiniciar containers
docker compose -f docker-compose.prod.yml up -d

# Verificar
curl -s https://api.lifeservicos.com/health
```

---

## SCRIPTS AUXILIARES

### Script: Verificar Duplicatas em Mensalidades

```bash
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "
  SELECT
    cpf,
    matricula,
    financiamento_code,
    COUNT(*) as total,
    STRING_AGG(ref_month::text || '/' || ref_year::text, ', ') as referencias
  FROM payroll_lines
  GROUP BY cpf, matricula, financiamento_code
  HAVING COUNT(*) > 1
  ORDER BY total DESC
  LIMIT 20;
"
```

### Script: Executar Limpeza Manual (se necess√°rio)

```bash
# SSH no servidor
ssh root@72.60.158.156

# Entrar no container API
docker exec -it src-api-1 bash

# Executar script de limpeza (modo simula√ß√£o)
cd /app/apps/api
python cleanup_old_payroll_data.py --dry-run

# Se OK, executar limpeza real
python cleanup_old_payroll_data.py
# Digite: CONFIRMO

# Verificar resultado
exit

# Verificar no banco
docker exec src-db-1 psql -U lifecalling -d lifecalling -c "
  SELECT COUNT(*) FROM payroll_lines;
"
```

---

## CHECKLIST FINAL

### Antes do Deploy
- [ ] Backup criado e salvo em $BACKUP_DIR
- [ ] Backup validado (tamanho > 100 KB, linhas > 10000)
- [ ] Teste de restaura√ß√£o executado e bem-sucedido
- [ ] C√≥digo atualizado (git pull)
- [ ] Commit correto verificado (0d7484f)

### Durante o Deploy
- [ ] Containers parados (api, web)
- [ ] C√≥digo atualizado
- [ ] Containers reiniciados
- [ ] Logs sem erros cr√≠ticos

### Ap√≥s o Deploy
- [ ] Health check OK
- [ ] Filtros de banco e cargo funcionando
- [ ] Navega√ß√£o entre casos sem modal
- [ ] Importa√ß√£o de folha com limpeza autom√°tica
- [ ] Sem duplicatas em payroll_lines
- [ ] Monitoramento ativo (24h)

---

## CONTATOS DE EMERG√äNCIA

- **Servidor**: root@72.60.158.156
- **Diret√≥rio**: /opt/lifeservicos/src
- **GitHub**: https://github.com/ghitflux/lifeservicos
- **Branch**: life-system
- **Backups**: /opt/lifeservicos/backups/

---

## NOTAS T√âCNICAS

### Mudan√ßa na L√≥gica de Mensalidades

**Antes**:
```sql
WHERE rn > 2  -- Mantinha 2 mensalidades mais recentes
```

**Depois**:
```sql
WHERE rn > 1  -- Mant√©m apenas 1 mensalidade mais recente
```

**Impacto**: ~44 MB economizados, queries mais r√°pidas

### Filtros Normalizados de Banco

**Problema**: Filtro retornava "BANCO DO BRASIL" mas API buscava "BANCO DO BRASIL S.A"

**Solu√ß√£o**: Buscar todas as varia√ß√µes do nome normalizado
```python
normalize_bank_name("BANCO DO BRASIL S.A") == "BANCO DO BRASIL"
matching_entities = [e for e in all if normalize_bank_name(e) == filter]
```

### Navega√ß√£o Simplificada

**Antes**: Modal ‚Üí Textarea ‚Üí Valida√ß√£o ‚Üí Salvar ‚Üí Navegar
**Depois**: Click ‚Üí Navegar diretamente

---

## OBSERVA√á√ïES FINAIS

1. **Backup Cr√≠tico**: Validar SEMPRE antes de prosseguir
2. **Mensalidades**: Sistema mant√©m apenas a mais recente
3. **Filtros**: Banco e Cargo agora funcionam corretamente
4. **Performance**: Banco mais leve, queries mais r√°pidas
5. **Compatibilidade**: 100% retrocompat√≠vel

---

**Documentado por**: Claude Code
**Commit**: 0d7484f
**Branch**: life-system
**Data**: 03/12/2025
