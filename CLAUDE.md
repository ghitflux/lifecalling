# Documenta√ß√£o de Altera√ß√µes - LifeCalling v1

## √öltima Atualiza√ß√£o: 24/10/2025

## √öltima Atualiza√ß√£o: 21/10/2025

---

## üìã √çndice de Sess√µes

1. [Corre√ß√µes Cr√≠ticas no M√≥dulo Financeiro (24/10/2025)](#corre√ß√µes-cr√≠ticas-m√≥dulo-financeiro-24102025)
2. [Sistema de Cancelamento de Casos (21/10/2025)](#sistema-de-cancelamento-21102025)
3. [Sistema de Hist√≥rico de Simula√ß√µes (20/10/2024)](#sistema-de-hist√≥rico-20102024)
## üî• Corre√ß√µes Cr√≠ticas no M√≥dulo Financeiro (24/10/2025)

### üìã Resumo Geral

Corre√ß√£o completa do m√≥dulo financeiro com foco em:
1. **Sistema de reabertura de casos** efetivados para ajustes
2. **Novos c√°lculos de KPI** (Receita Total, Impostos, Despesas)
3. **Tipo de receita "Consultoria Bruta"** manual com campos obrigat√≥rios
4. **10 bugs cr√≠ticos** corrigidos (sintaxe, l√≥gica, UX)

**Total de commits:** 8
**Arquivos modificados:** 7 (3 backend + 4 frontend)
**Linhas alteradas:** ~500

---

### üéØ Funcionalidades Implementadas

#### 1. Sistema de Reabertura de Casos Efetivados

**Objetivo:** Permitir que Admin e Financeiro reabram casos efetivados para ajustar valores.

**Backend - Endpoint Criado:**
- `POST /finance/cases/{case_id}/reopen` (finance.py linha ~718)
- Permiss√µes: Admin e Financeiro apenas
- A√ß√µes: Status ‚Üí financeiro_pendente + Exclui receitas autom√°ticas

**Frontend:**
- FinanceCard: Bot√£o "Reabrir para Ajuste" (laranja, √≠cone RotateCcw)
- Hook: `useReopenCase()` com invalida√ß√£o de queries
- Handler: `handleReopen()` integrado

**Fluxo Completo:**
1. Usu√°rio clica "Reabrir para Ajuste"
2. Confirma√ß√£o: "Deseja reabrir...? Receitas ser√£o exclu√≠das."
3. Backend altera status + exclui receitas
4. Frontend mostra em "Aguardando Financeiro"

---

#### 2. Novos C√°lculos de KPI

| Card | Antes | Depois |
|------|-------|--------|
| Receita Total | Consultoria L√≠q + Ext + Man | **Consultoria Bruta** + Ext + Man |
| Impostos | Apenas manuais | Manuais + **14% autom√°tico** |
| Despesas | Apenas manuais | Manuais + Impostos |
| Consultoria L√≠q | 86% do custo | 86% (mant√©m) |

**Implementa√ß√£o (finance.py linhas 367-465):**
- Consultoria Bruta = Œ£ custo_consultoria (simula√ß√µes efetivadas)
- Receita Total = Bruta + Externas + Manuais
- Impostos = Manuais + (Receita * 14%)
- Despesas = Manuais + Impostos

---

#### 3. Tipo "Consultoria Bruta" Manual

**Campos Obrigat√≥rios:**
- Atendente (dropdown role "atendente")
- CPF do Cliente (m√°scara ###.###.###-##)
- Nome do Cliente (texto)

**Valida√ß√£o Backend (finance.py 1531-1542):**
- Verifica se campos est√£o preenchidos
- Valida formato CPF (11 d√≠gitos)
- Retorna erro 400 se inv√°lido

**UI (IncomeModal.tsx 198-266):**
- Box laranja com contraste melhorado
- Campos condicionais (s√≥ aparecem se tipo = "Consultoria Bruta")
- Integra√ß√£o com ranking de atendentes

---

### üêõ Bugs Cr√≠ticos Corrigidos

1. **KPIs Zerados (500)**: Falta imports Simulation/Case ‚Üí Adicionados ‚úÖ
2. **CPF "-" na tabela**: GET /transactions sem else ‚Üí Adicionado else ‚úÖ
3. **Bot√£o n√£o aparece**: L√≥gica dentro bloco errado ‚Üí Bloco separado ‚úÖ
4. **Contraste ruim**: Texto claro em fundo claro ‚Üí text-gray-900 + bg-white ‚úÖ
5. **Hover claro**: bg-amber-50 + texto marrom ‚Üí bg-amber-600 + texto branco ‚úÖ
6. **Status "Liberado"**: contract antes de status ‚Üí Reordenado ‚úÖ
7. **Filtro vazio**: && !i.contract exclu√≠a casos ‚Üí Removido ‚úÖ
8. **CPF vazio efetiva√ß√£o**: Falta client_cpf/name ‚Üí Adicionados ‚úÖ
9-10. **Erros JSX**: Tags abertas + imports ‚Üí Corrigidos ‚úÖ

---

### üìä Arquivos Modificados

**Backend:**
1. models.py - client_cpf + client_name
2. finance.py - Endpoint reopen + m√©tricas + valida√ß√µes + CPF efetiva√ß√£o
3. add_client_fields_to_finance_incomes.sql - Migra√ß√£o ‚úÖ

**Frontend:**
4. page.tsx (financeiro) - L√≥gica status + filtro + handler
5. hooks.ts - useReopenCase
6. IncomeModal.tsx - Campos condicionais + contraste
7. FinanceCard.tsx - Bot√£o reabrir + hover

---

### üìù Commits (8 total)

- c32d023: feat - Reabertura + KPIs
- 0c5e1d4: fix - Sintaxe JSX FinanceCard
- 18c4837: fix - Sintaxe JSX + imports
- bb3ec0d: fix - Bugs cr√≠ticos
- 6f652df: fix - CPF/Nome + Bot√£o
- 8f767c5: fix - Bug reabertura + contraste
- 7747a6b: fix - Filtro Aguardando Financeiro
- 08a0fec: fix - CPF efetiva√ß√£o

---

### üìä Estat√≠sticas

**Vers√£o:** 1.6
**Data:** 24/10/2025
**Funcionalidades:** 3
**Bugs Corrigidos:** 10
**Arquivos:** 7
**Linhas:** ~500

---


---


---

## üî• Sistema de Cancelamento de Casos (21/10/2025)

### üìã Resumo Geral

Corre√ß√£o completa do sistema de cancelamento de casos:
1. **Status espec√≠fico "caso_cancelado"** criado
2. **Preven√ß√£o de duplica√ß√£o** de casos cancelados
3. **Prote√ß√£o contra reabertura** em importa√ß√µes de folha
4. **Interface visual** consistente (vermelho para cancelados)
5. **Bot√µes de refresh** funcionais em todos os m√≥dulos
6. **Filtros completos** mostrando todos os 14 status
7. **10 bugs cr√≠ticos** corrigidos

### üéØ Problemas Corrigidos

#### Problema 1: Broadcast WebSocket Inconsistente
- **Status no banco:** `"encerrado"`
- **Broadcast WebSocket:** `"cancelado"` ‚ùå
- **Corre√ß√£o:** Status e broadcast agora s√£o `"caso_cancelado"` ‚úÖ

#### Problema 2: Reabertura Autom√°tica Indevida
- **Antes:** Casos cancelados eram reabertos como "novo" ap√≥s importa√ß√£o
- **Depois:** Casos cancelados mant√™m status ap√≥s importa√ß√£o ‚úÖ

#### Problema 3-5: Frontend N√£o Mostrava Status Correto
- Endpoint `/finance/queue` n√£o retornava casos cancelados
- Contador e filtro "Cancelados" incompletos
- **Corre√ß√£o:** Ambos incluem `"caso_cancelado"` e `"contrato_cancelado"` ‚úÖ

#### Problema 6-7: Interface Visual Incorreta
- Status aparecia como "Fechamento Aprovado" (verde) em vez de "Cancelado" (vermelho)
- Bot√£o "Efetivar Libera√ß√£o" aparecia em casos cancelados
- **Corre√ß√£o:** Status correto + bot√£o oculto ‚úÖ

#### Problema 8: Sistema Criava Casos Duplicados (CR√çTICO)
- **Situa√ß√£o:** Cliente com caso #52 (cancelado) ‚Üí importa√ß√£o criava caso #54 (novo)
- **Causa Raiz:** Casos cancelados n√£o estavam em nenhuma categoria (OPEN/CLOSED)
- **Corre√ß√£o:** Nova categoria `CANCELED_STATUSES` implementada ‚úÖ

#### Problemas 9-10: Bot√µes de Refresh N√£o Funcionavam
- Financeiro: N√£o tinha bot√£o para atualizar lista de casos
- Calculista: Bot√£o gen√©rico `refetchQueries()` n√£o funcionava
- **Corre√ß√£o:** Bot√µes espec√≠ficos com queries corretas ‚úÖ

---

## üîß Sistema de Hist√≥rico de Simula√ß√µes (20/10/2024)

### üìã Resumo Geral

Implementa√ß√£o completa de:
1. Sistema de versionamento de simula√ß√µes
2. Hist√≥rico completo de todas as vers√µes
3. Corre√ß√£o do fluxo Fechamento ‚Üí Calculista ‚Üí Financeiro
4. Bot√£o de devolu√ß√£o de casos do Financeiro para Calculista
5. Bot√£o de cancelamento de casos
6. Melhorias de UX e corre√ß√µes de bugs

---

## üîß 1. Sistema de Hist√≥rico de Simula√ß√µes

### Problema Original
- Simula√ß√µes eram sobrescritas a cada edi√ß√£o
- Apenas a √∫ltima vers√£o ficava salva
- N√£o havia hist√≥rico de mudan√ßas
- Imposs√≠vel comparar vers√µes anteriores

### Solu√ß√£o Implementada

#### Backend (Python/FastAPI)

**Arquivo:** `apps/api/app/routers/simulations.py`

**Endpoint POST `/simulations/{case_id}` - Reformulado (linhas 257-384)**
```python
# ANTES: Sobrescrevia simula√ß√£o draft existente
existing_sim = db.query(Simulation).filter(
    Simulation.case_id == case_id,
    Simulation.status == "draft"
).first()

# DEPOIS: Sempre cria nova vers√£o
old_drafts = db.query(Simulation).filter(
    Simulation.case_id == case_id,
    Simulation.status == "draft"
).all()

for old_sim in old_drafts:
    old_sim.status = "superseded"  # ‚úÖ Marca como antiga

sim = Simulation(case_id=case_id, status="draft")  # ‚úÖ Nova vers√£o
```

**Novo status:** `"superseded"` - Identifica vers√µes antigas

**Novo Endpoint GET `/simulations/case/{case_id}/all` (linhas 547-605)**
- Retorna TODAS as simula√ß√µes de um caso
- Ordenadas por data (mais recente primeiro)
- Flag `is_current` identifica a simula√ß√£o ativa
- Suporta status: `draft`, `superseded`, `approved`, `rejected`

**Novo Endpoint POST `/simulations/{sim_id}/set-as-final` (linhas 706-763)**
- Define qual simula√ß√£o aprovada ser√° enviada ao financeiro
- Atualiza `Case.last_simulation_id`
- Permite escolher entre m√∫ltiplas simula√ß√µes aprovadas

#### Frontend (React/TypeScript)

**Arquivo:** `apps/web/src/lib/simulation-hooks.ts`

**Novos Hooks (linhas 301-344):**
```typescript
// Busca TODAS as simula√ß√µes de um caso
useAllCaseSimulations(caseId)

// Define simula√ß√£o como final
useSetFinalSimulation()
```

**Arquivo:** `packages/ui/src/SimulationHistoryModal.tsx`

**Melhorias:**
- Badge "ATUAL" para simula√ß√£o selecionada
- Status coloridos:
  - üü¢ Aprovada (verde)
  - ‚ùå Rejeitada (vermelho)
  - üîµ Rascunho (azul)
  - ‚ö™ Antiga/Superseded (cinza)
- Bot√£o "Selecionar como Final" para simula√ß√µes aprovadas
- Contador de vers√µes

---

## üîÑ 2. Corre√ß√£o do Fluxo: Fechamento ‚Üí Calculista ‚Üí Financeiro

### Problema Original
Quando caso voltava do fechamento aprovado, ao aprovar a simula√ß√£o ela retornava ao atendente em vez de ir direto ao financeiro.

### Solu√ß√£o

**Arquivo:** `apps/api/app/routers/simulations.py`

**Endpoint POST `/simulations/{sim_id}/approve` (linhas 406-476)**

```python
# ANTES: Sempre mudava para "calculo_aprovado"
case.status = "calculo_aprovado"

# DEPOIS: Detecta contexto
if case.status == "fechamento_aprovado":
    case.status = "financeiro_pendente"  # ‚úÖ Vai direto ao financeiro
else:
    case.status = "calculo_aprovado"     # ‚úÖ Vai ao fechamento
```

**Evento Adicional:**
- Quando vai ao financeiro, cria evento `case.sent_to_finance`
- Flag `auto_sent: true` identifica envio autom√°tico

---

## üîÅ 3. Devolu√ß√£o de Casos: Financeiro ‚Üí Calculista

### Implementa√ß√£o

**Backend:** `apps/api/app/routers/cases.py`

**Endpoint POST `/cases/{case_id}/return-to-calculista` (linhas 1583-1619)**
- Muda status para `"devolvido_financeiro"`
- Cria evento de rastreamento
- Permiss√µes: `admin`, `supervisor`, `financeiro`

**Frontend - FinanceCard:** `packages/ui/src/FinanceCard.tsx`

**Nova prop:** `onReturnToCalculista` (linha 65)

**Bot√£o "Devolver" (linhas 586-598)**
```typescript
<Button
  className="text-orange-600 border-orange-400
             hover:bg-orange-600 hover:text-white"
>
  <Undo2 /> Devolver
</Button>
```

**Frontend - Dashboard Calculista:** `apps/web/src/app/calculista/page.tsx`

**Nova Aba "Devolvidos" (linhas 254-265, 434-436, 573-631)**
- Query busca casos com status `"devolvido_financeiro"`
- Visual destacado em laranja
- Card com aviso "‚ö†Ô∏è Devolvido para rec√°lculo pelo financeiro"

---

## ‚ùå 4. Cancelamento de Casos

### Implementa√ß√£o

**Backend:** `apps/api/app/routers/cases.py`

**Endpoint POST `/cases/{case_id}/cancel`**
```python
@r.post("/{case_id}/cancel")
async def cancel_case(case_id: int, user=...):
    """Cancela um caso (muda status para 'encerrado')"""
    case.status = "encerrado"  # ‚úÖ Status correto
    # Cria evento case.cancelled
    # Broadcast via WebSocket
```

**Permiss√µes:** `admin`, `supervisor`, `financeiro`

**Frontend - FinanceCard:** `packages/ui/src/FinanceCard.tsx`

**Modal de Confirma√ß√£o (linhas 1118-1157)**
- Dialog profissional
- √çcone de alerta ‚ö†Ô∏è
- Mensagem clara com nome do cliente
- Bot√µes "Voltar" e "Cancelar Caso"

**Bot√£o "Cancelar Caso" (linhas 614-624)**
- Variant destructive (vermelho)
- Full-width
- Abre modal de confirma√ß√£o

---

## ‚ö° 5. Aprovar Sem Precisar Recalcular

### Problema
Calculista era obrigado a clicar em "Calcular Simula√ß√£o" mesmo sem editar nada, apenas para habilitar "Aprovar e Enviar".

### Solu√ß√£o

**Arquivo:** `apps/web/src/app/calculista/[caseId]/page.tsx`

**useEffect Adicional (linhas 121-157)**
- Carrega simula√ß√£o automaticamente quando vem do fechamento
- Popula `simulationId` e `currentTotals`
- Preenche formul√°rio com dados existentes

**Fun√ß√£o handleApprove (linhas 226-235)**
```typescript
// ‚úÖ Usa fallback para last_simulation_id
const simIdToApprove = simulationId || caseDetail?.last_simulation_id;

if (!simIdToApprove) {
  toast.error("Salve a simula√ß√£o antes de aprovar");
  return;
}
approveSimulationMutation.mutate(simIdToApprove);
```

**Benef√≠cio:** Calculista pode aprovar direto sem recalcular!

---

## üé® 6. Melhorias de UI/UX

### FinanceCard - Bot√µes Reorganizados

**Arquivo:** `packages/ui/src/FinanceCard.tsx` (linhas 571-627)

**Layout para status `financeiro_pendente`:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Linha 1: [Ver Detalhes] [Devolver] ‚îÇ  (inline)
‚îÇ Linha 2: [Efetivar Libera√ß√£o]      ‚îÇ  (full-width, verde)
‚îÇ Linha 3: [Cancelar Caso]           ‚îÇ  (full-width, vermelho)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Bot√£o "Devolver" com hover melhorado:**
- Estado normal: Texto laranja + borda laranja
- Hover: Fundo laranja + texto branco ‚úÖ

### Status da Simula√ß√£o

**Arquivo:** `apps/web/src/app/financeiro/page.tsx` (linhas 922-928)

```typescript
// ‚úÖ Corrigido mapeamento de status
if (item.status === "financeiro_pendente") return "financeiro_pendente";
if (item.status === "fechamento_aprovado") return "fechamento_aprovado";
```

---

## üêõ 7. Corre√ß√µes de Bugs

### Bug 1: Erro React Key
**Arquivo:** `packages/ui/src/SimulationHistoryModal.tsx` (linha 200)

```typescript
// ANTES:
key={entry.simulation_id}

// DEPOIS:
key={`simulation-${entry.simulation_id}-${index}`}
```

### Bug 2: Exclus√£o de Despesas de Comiss√£o
**Arquivo:** `apps/api/app/routers/finance.py` (linha 1174)

```python
# ANTES:
user=Depends(require_roles("admin", "supervisor"))

// DEPOIS:
user=Depends(require_roles("admin", "supervisor", "financeiro"))
```

### Bug 3: KPIs com Erro 500
**Arquivo:** `apps/web/src/app/calculista/page.tsx` (linhas 151-154)

```typescript
// Temporariamente desabilitado
// const { data: kpis } = useCalculationKpis({ month: currentMonth });
const kpis = null;
const isLoadingKpis = false;
```

---

## üìä Fluxo Completo Atualizado

```
ATENDENTE cria caso
  ‚Üì
CALCULISTA calcula e aprova
  ‚Üì (status: calculo_aprovado)
ATENDENTE envia ao fechamento
  ‚Üì
FECHAMENTO aprova
  ‚Üì (status: fechamento_aprovado)
CALCULISTA revisa
  ‚îú‚îÄ‚Üí [Op√ß√£o A] Aprova direto (sem editar)
  ‚îÇ   ‚îî‚îÄ‚Üí FINANCEIRO (status: financeiro_pendente) ‚úÖ
  ‚îî‚îÄ‚Üí [Op√ß√£o B] Edita e aprova
      ‚îî‚îÄ‚Üí FINANCEIRO (status: financeiro_pendente) ‚úÖ
  ‚Üì
FINANCEIRO recebe
  ‚îú‚îÄ‚Üí [Op√ß√£o A] Efetiva contrato ‚Üí ENCERRADO ‚úÖ
  ‚îú‚îÄ‚Üí [Op√ß√£o B] Devolve para rec√°lculo
  ‚îÇ   ‚îî‚îÄ‚Üí CALCULISTA (status: devolvido_financeiro)
  ‚îî‚îÄ‚Üí [Op√ß√£o C] Cancela caso ‚Üí ENCERRADO ‚úÖ
```

---

## üìù Arquivos Modificados

### Backend (Python/FastAPI)
1. `apps/api/app/routers/simulations.py` - Sistema de versionamento
2. `apps/api/app/routers/cases.py` - Endpoints de devolu√ß√£o e cancelamento
3. `apps/api/app/routers/finance.py` - Permiss√µes de exclus√£o

### Frontend (React/TypeScript)
1. `apps/web/src/lib/simulation-hooks.ts` - Novos hooks
2. `apps/web/src/app/calculista/[caseId]/page.tsx` - Aprova√ß√£o sem recalcular
3. `apps/web/src/app/calculista/page.tsx` - Aba de devolvidos
4. `apps/web/src/app/financeiro/page.tsx` - Handlers de a√ß√µes
5. `packages/ui/src/FinanceCard.tsx` - Bot√µes e modais
6. `packages/ui/src/SimulationHistoryModal.tsx` - Hist√≥rico visual

---

## üéØ Benef√≠cios Entregues

‚úÖ **Rastreabilidade Total** - Hist√≥rico completo de todas as vers√µes
‚úÖ **Sem Perda de Dados** - Todas as simula√ß√µes ficam salvas
‚úÖ **Fluxo Correto** - Casos v√£o direto ao financeiro ap√≥s fechamento
‚úÖ **Flexibilidade** - Financeiro pode devolver casos problem√°ticos
‚úÖ **UX Melhorada** - N√£o precisa recalcular desnecessariamente
‚úÖ **Visual Claro** - Badges e cores identificam status facilmente
‚úÖ **Auditoria** - Eventos rastreiam todas as a√ß√µes

---

---

## üöÄ Pr√≥ximas Melhorias e Corre√ß√µes

### üéØ Alta Prioridade

#### 1. **Campo Edit√°vel para Consultoria L√≠quida na Efetiva√ß√£o**

**Problema:**
- Valor da consultoria calculado na simula√ß√£o √†s vezes precisa ser ajustado
- Pode ser valor diferente ou valor fixo
- Financeiro n√£o consegue editar manualmente

**Solu√ß√£o Proposta:**
```typescript
// Modal de Efetivar Contrato - adicionar campo edit√°vel
<Input
  label="Consultoria L√≠quida"
  value={consultoriaLiquidaEditavel}
  onChange={(v) => setConsultoriaLiquidaEditavel(v)}
  type="currency"
  defaultValue={simulacao.totals.custoConsultoriaLiquido}
/>
```

**Benef√≠cios:**
- ‚úÖ Financeiro pode ajustar valor manualmente
- ‚úÖ Valor editado substitui o da simula√ß√£o
- ‚úÖ Flexibilidade para casos especiais
- ‚úÖ Mant√©m rastreabilidade (valor original + ajustado)

**Arquivos a Modificar:**
- `packages/ui/src/FinanceCard.tsx` - Modal de efetiva√ß√£o
- `apps/api/app/routers/finance.py` - Endpoint POST `/finance/disburse`
- `apps/api/app/models.py` - Adicionar campo `consultoria_liquida_ajustada` (opcional)

---

#### 2. **Ajustes no Sistema de Impostos**

**Itens a Revisar:**
- [ ] C√°lculo de IRPF (Imposto de Renda Pessoa F√≠sica)
- [ ] C√°lculo de INSS (Instituto Nacional do Seguro Social)
- [ ] Al√≠quotas progressivas corretas
- [ ] Dedu√ß√µes e isen√ß√µes aplic√°veis
- [ ] Tabelas atualizadas (2025)

**Arquivos Envolvidos:**
- `apps/web/src/lib/utils/simulation-calculations.ts`
- `apps/api/app/utils/calculations.py` (se existir)

**A√ß√£o Requerida:**
- Especificar quais impostos/c√°lculos est√£o incorretos
- Fornecer regras de neg√≥cio corretas
- Validar com exemplos reais

---

#### 3. **Distribui√ß√£o da Consultoria L√≠quida (Atendente + Balc√£o)**

**Regra Atual:**
- 100% da consultoria l√≠quida vai para o financeiro
- Comiss√£o separada (configur√°vel por caso)

**Nova Regra Proposta:**
```
Consultoria L√≠quida Total
  ‚îú‚îÄ‚Üí Porcentagem para Atendente (configur√°vel, ex: 70%)
  ‚îÇ   ‚îî‚îÄ‚Üí Receita do Atendente
  ‚îî‚îÄ‚Üí Diferen√ßa Restante (ex: 30%)
      ‚îî‚îÄ‚Üí Receita do Balc√£o (consultoria)

‚ùå REMOVER sistema de "Comiss√£o" separado
‚úÖ USAR apenas sistema de distribui√ß√£o percentual
```

**Exemplo:**
```
Consultoria L√≠quida: R$ 1.000,00
Atendente (70%): R$ 700,00
Balc√£o (30%): R$ 300,00
```

**Implementa√ß√£o:**
1. Adicionar campo `percentual_atendente` na efetiva√ß√£o do contrato
2. Calcular automaticamente:
   - `receita_atendente = consultoria_liquida * (percentual_atendente / 100)`
   - `receita_balcao = consultoria_liquida - receita_atendente`
3. Criar 2 entradas na tabela de receitas:
   - Receita tipo "Consultoria - Atendente" (user_id = atendente)
   - Receita tipo "Consultoria - Balc√£o" (user_id = null ou admin)
4. Remover sistema de "Comiss√£o"

**Arquivos a Modificar:**
- `apps/api/app/routers/finance.py` - Endpoint POST `/finance/disburse`
- `apps/api/app/models.py` - Modelo Contract/Revenue
- `packages/ui/src/FinanceCard.tsx` - Modal de efetiva√ß√£o
- `apps/web/src/app/financeiro/page.tsx` - Tabela de receitas

---

#### 4. **M√≥dulo de Cria√ß√£o de Cliente/Caso**

**Objetivo:**
- Interface para criar clientes manualmente (n√£o via importa√ß√£o)
- Criar casos manualmente

**Funcionalidades:**
1. **Formul√°rio de Cria√ß√£o de Cliente:**
   - Nome completo
   - CPF (valida√ß√£o)
   - Matr√≠cula
   - √ìrg√£o/Entidade
   - Telefone preferencial
   - Banco, Ag√™ncia, Conta
   - Chave PIX (opcional)
   - Observa√ß√µes

2. **Cria√ß√£o Autom√°tica de Caso:**
   - Ao criar cliente, criar caso automaticamente
   - Status inicial: "novo"
   - Atribuir ao usu√°rio que criou (opcional)

3. **Valida√ß√µes:**
   - CPF √∫nico (n√£o permitir duplicatas)
   - Formato de CPF v√°lido
   - Campos obrigat√≥rios

**Arquivos a Criar/Modificar:**
- `apps/web/src/app/clientes/novo/page.tsx` - P√°gina de cria√ß√£o
- `apps/api/app/routers/clients.py` - Endpoint POST `/clients`
- `packages/ui/src/ClientForm.tsx` - Componente de formul√°rio

**Layout Sugerido:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Novo Cliente                            ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Dados Pessoais]                        ‚îÇ
‚îÇ Nome: ___________                       ‚îÇ
‚îÇ CPF: ___________                        ‚îÇ
‚îÇ Matr√≠cula: ___________                  ‚îÇ
‚îÇ √ìrg√£o: ___________                      ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Contato]                               ‚îÇ
‚îÇ Telefone: ___________                   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Dados Banc√°rios]                       ‚îÇ
‚îÇ Banco: ___________                      ‚îÇ
‚îÇ Ag√™ncia: ___________                    ‚îÇ
‚îÇ Conta: ___________                      ‚îÇ
‚îÇ Chave PIX: ___________                  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Observa√ß√µes]                           ‚îÇ
‚îÇ ___________                             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [Cancelar] [Criar Cliente e Caso]      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### üìù Melhorias Secund√°rias

#### 5. Filtros de Busca no Hist√≥rico de Simula√ß√µes
- Buscar por data
- Buscar por status
- Buscar por valor

#### 6. Coment√°rios/Notas nas Devolu√ß√µes
- Campo de texto ao devolver caso
- Hist√≥rico de coment√°rios vis√≠vel

#### 7. Relat√≥rio de Casos Devolvidos
- M√©tricas de devolu√ß√µes
- Motivos mais comuns
- Usu√°rios com mais devolu√ß√µes

#### 8. Notifica√ß√µes Push
- Quando caso √© devolvido
- Quando caso √© aprovado
- Quando contrato √© efetivado

#### 9. Corrigir Endpoint `/calculation/kpis`
- Atualmente retorna erro 500
- Desabilitado temporariamente

---

### üìä Estat√≠sticas Acumuladas

**Vers√£o Atual:** 1.5
**Data:** 21/10/2025

**Total de Funcionalidades Implementadas:**
- ‚úÖ Sistema de Hist√≥rico de Simula√ß√µes
- ‚úÖ Sistema de Cancelamento Completo
- ‚úÖ Devolu√ß√£o de Casos (Financeiro ‚Üí Calculista)
- ‚úÖ Filtros Completos de Status
- ‚úÖ Bot√µes de Refresh Funcionais

**Total de Bugs Corrigidos:** 15+
**Total de Arquivos Modificados:** 15+
**Total de Linhas Alteradas:** ~500+

---

**Documenta√ß√£o gerada e mantida por Claude Code**
**√öltima Atualiza√ß√£o:** 21/10/2025
